<!doctype html>
<html lang="fr-CA">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Les Neurones Émotives</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.21.0/dist/tf.min.js"></script>
<style>
:root{
  --bg1:#548399;
  --bg2:#24576d;
  --glass:rgba(255,255,255,0.16);
  --glass-strong:rgba(255,255,255,0.25);
  --border:rgba(255,255,255,0.35);
  --text:#ffffff;
  --muted:#e6f6ff;
  --accent:#0ea5e9;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;color:var(--text);
  background:linear-gradient(135deg,var(--bg1),var(--bg2));
}
button,select,input[type=range],input[type=checkbox],label{font:inherit}
#app{display:grid;grid-template-columns:1fr 1fr;grid-template-rows:1fr 1fr;height:100vh;gap:12px;padding:12px}
.card{background:var(--glass);border:1px solid var(--border);border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.1);
  padding:12px;display:flex;flex-direction:column;backdrop-filter:blur(14px)}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;background:var(--glass-strong);border:1px solid var(--border)}
.badge.lock{background:rgba(30,64,175,.35)}
.split{display:flex;gap:10px;align-items:center}
.grid{display:grid;gap:8px}
.thumbs{display:grid;grid-template-columns:repeat(auto-fill,34px);gap:6px;align-content:start;overflow:auto;max-height:220px;border:1px solid var(--border);border-radius:10px;padding:6px;background:rgba(255,255,255,0.08)}
.thumb{width:32px;height:32px;border:1px solid var(--border);border-radius:6px;position:relative;background:#fff}
.thumb.test::after{content:"T";position:absolute;top:-6px;right:-6px;background:#1b4ed4;color:#fff;font-size:10px;border-radius:999px;padding:1px 3px}
.panel-title{display:flex;justify-content:space-between;align-items:center}
.controls{display:grid;grid-template-columns:repeat(6, minmax(80px,1fr));gap:8px}
.metrics{display:flex;gap:10px;align-items:center}
#draw,#testpad{border:1px solid var(--border);background:#fff;border-radius:12px;touch-action:none;width:224px;height:224px}
.kv{display:grid;grid-template-columns:auto 1fr;gap:6px 12px;align-items:center}
#filters{display:grid;grid-template-columns:repeat(8, 34px);gap:6px;align-content:start;overflow:auto;max-height:100px}
.filter{width:32px;height:32px;border:1px solid var(--border);border-radius:6px;background:#fff}
#nnviz{width:100%;height:240px;border:1px solid var(--border);border-radius:12px;background:rgba(255,255,255,0.08)}
.counts{font-size:12px;color:var(--muted)}
.actions{display:flex;gap:8px;align-items:center}
.legend{display:flex;gap:8px;align-items:center;font-size:12px}
.bar{height:10px;background:#0ea5e9;border-radius:6px}
.predrow{display:grid;grid-template-columns:80px 1fr 44px;gap:8px;align-items:center}
.layer-row{display:flex;align-items:center;gap:6px}
.layer-pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:2px 8px;background:var(--glass-strong);backdrop-filter:blur(10px)}
.layer-pill button{width:24px;height:24px;border:1px solid var(--border);border-radius:999px;background:rgba(255,255,255,0.2);cursor:pointer;color:var(--text);display:flex;align-items:center;justify-content:center;padding:0;line-height:1}

.layer-pill span{min-width:20px;text-align:center}
.canvas-draw-wrapper {
  display: flex;
  justify-content: left;
  
  margin: 20px 0; /* same margin top and bottom */
}

.canvas-test-wrapper {
  display: flex;
  justify-content: left;
  margin-bottom: 20px; /* same margin top and bottom */
}

button{border:1px solid var(--border);background:rgba(255,255,255,0.2);color:var(--text);border-radius:10px;padding:6px 10px;cursor:pointer}
button:hover{background:rgba(255,255,255,0.28)}
button:disabled{opacity:.6;cursor:not-allowed}
input[type=range]{width:200px;accent-color:var(--accent)}
input[type=checkbox]{accent-color:var(--accent)}
select{border:1px solid var(--border);background:rgba(255,255,255,0.2);color:var(--text);border-radius:10px;padding:4px}
hr{border:none;border-top:1px solid var(--border);margin:8px 0}
#pane-dataset{position:relative}
#augInfo{position:absolute;left:12px;bottom:12px}
</style>
</head>
<body>
<div id="app">
  <div class="card" id="pane-draw">
    <div class="panel-title"><h2>Ajouter des données</h2><div class="badge" id="classCounts"></div></div>
    <div class="row">
      <div class="row">
        <label><input type="radio" name="label" value="content" checked> Content</label>
        <label><input type="radio" name="label" value="Triste"> Triste</label>
        <label><input type="radio" name="label" value="Neutre"> Neutre</label>
      </div>
      <div class="actions">
        <button id="clear">Effacer</button>
        <button id="add">Ajouter l’exemple</button>
      </div>
    </div>
    <div class="canvas-draw-wrapper">
  <canvas id="draw"></canvas>
</div>

  </div>
  <div class="card" id="pane-dataset">
    <div class="panel-title"><h2>Jeu de données</h2><span id="lockBadge" class="badge">Test déverrouillé</span></div>
    <div class="row split">
      <label>% entraînement</label>
      <input type="range" id="split" min="50" max="90" value="70">
      <span id="splitLabel">70/30</span>
    </div>
    <div class="counts" id="splitCounts"></div>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:8px">
      <div>
        <h3>Content</h3>
        <div id="thumb-content" class="thumbs"></div>
      </div>
      <div>
        <h3>Triste</h3>
        <div id="thumb-triste" class="thumbs"></div>
      </div>
      <div>
        <h3>Neutre</h3>
        <div id="thumb-neutre" class="thumbs"></div>
      </div>
    </div>
    <div class="counts" id="augInfo">Entraînement effectif : 0</div>
  </div>
  <div class="card" id="pane-nn">
    <div class="panel-title"><h2>Réseau de neurones</h2><div class="metrics"><span id="trainBadge" class="badge">Entraînement : –</span><span id="testBadge" class="badge">Test : –</span></div></div>
    <div class="row" id="layerControls"></div>
    <div class="row" style="gap:12px;margin-top:6px">
      <button id="addLayer">Ajouter</button>
      <button id="removeLayer">Supprimer</button>
      <button id="train">Entraîner</button>
      <button id="reset">Réinitialiser</button>
    </div>
    <div style="margin-top:10px">
      <div style="font-size:12px;color:var(--muted);margin-bottom:6px">Filtres de la première couche</div>
      <div id="filters"></div>
    </div>
    <div style="margin-top:10px">
      <div style="font-size:12px;color:var(--muted);margin-bottom:6px">Réseau</div>
      <svg id="nnviz"></svg>
    </div>
  </div>
  <div class="card" id="pane-test">
    <div class="panel-title"><h2>Testeur</h2><span class="badge" id="warnBadge">Prêt</span></div>

  <div class="canvas-test-wrapper">
  <canvas id="testpad"></canvas>
</div>



    <div class="row" style="margin-top:8px">
      <button id="testclear">Effacer</button>
      <button id="predict">Prédire</button>
    </div>
    <div style="margin-top:10px">
      <div class="predrow"><div>Content</div><div class="bar" id="bar-content"></div><div id="prob-content">–</div></div>
      <div class="predrow"><div>Triste</div><div class="bar" id="bar-triste"></div><div id="prob-triste">–</div></div>
      <div class="predrow"><div>Neutre</div><div class="bar" id="bar-neutre"></div><div id="prob-neutre">–</div></div>
    </div>
  </div>
</div>
<script>
const labels=["content","Triste","Neutre"]
const state={samples:[],rngSeed:12345,splitPct:0.7,testLocked:false,model:null,arch:{filters:6,hiddenLayers:[8]},trainIds:new Set(),testIds:new Set(),augment:true,targetPerClass:48}
const draw=document.getElementById("draw")
const testpad=document.getElementById("testpad")
let ctx, tctx
function setupHiDPICanvas(canvas){
  const dpr=window.devicePixelRatio||1
  const rect=canvas.getBoundingClientRect()
  canvas.width=Math.round(rect.width*dpr)
  canvas.height=Math.round(rect.height*dpr)
  const c=canvas.getContext("2d")
  c.setTransform(dpr,0,0,dpr,0,0)
  return c
}
function resetCanvas(c,context){
  context.fillStyle="#fff";context.fillRect(0,0,c.clientWidth,c.clientHeight)
  context.lineCap="round";context.strokeStyle="#000"
  
}
function getPos(e,canvas){
  const rect=canvas.getBoundingClientRect()
  return {x:e.clientX-rect.left,y:e.clientY-rect.top}
}
function initCanvases(){
  ctx=setupHiDPICanvas(draw);tctx=setupHiDPICanvas(testpad)
  resetCanvas(draw,ctx);resetCanvas(testpad,tctx)
}
initCanvases();
window.addEventListener('resize', initCanvases)
let brush=8
function onPointer(canvas,context){
  let p=false
  canvas.addEventListener("pointerdown",e=>{p=true;const {x,y}=getPos(e,canvas);context.beginPath();context.moveTo(x,y)})
  canvas.addEventListener("pointermove",e=>{if(!p)return;context.lineWidth=brush;const {x,y}=getPos(e,canvas);context.lineTo(x,y);context.stroke()})
  window.addEventListener("pointerup",()=>{p=false})
}
onPointer(draw,ctx);onPointer(testpad,tctx)
document.getElementById("clear").addEventListener("click",()=>{resetCanvas(draw,ctx)})
document.getElementById("testclear").addEventListener("click",()=>{resetCanvas(testpad,tctx)})
function currentLabel(){return document.querySelector("input[name=label]:checked").value}
function to28x28(canvas){
  const tmp=document.createElement("canvas");tmp.width=28;tmp.height=28
  const t=tmp.getContext("2d");t.fillStyle="#fff";t.fillRect(0,0,28,28);t.drawImage(canvas,0,0,28,28)
  const img=t.getImageData(0,0,28,28).data
  const arr=new Float32Array(28*28)
  for(let i=0,j=0;i<img.length;i+=4,j++){const r=img[i],g=img[i+1],b=img[i+2];const gray=(r+g+b)/3/255;arr[j]=1-gray}
  return arr
}
function seedRand(seed){let s=seed%2147483647;if(s<=0)s+=2147483646;return()=>{s=s*16807%2147483647;return(s-1)/2147483646}}
function stratifiedSplit(){
  state.trainIds.clear();state.testIds.clear()
  const rnd=seedRand(state.rngSeed)
  for(const lab of labels){
    const idx=state.samples.map((s,i)=>[s,i]).filter(([s,i])=>s.label===lab).map(([s,i])=>i)
    for(let i=idx.length-1;i>0;i--){const j=Math.floor(rnd()* (i+1));[idx[i],idx[j]]=[idx[j],idx[i]]}
    const nTrain=Math.floor(idx.length*state.splitPct)
    for(let i=0;i<idx.length;i++){const id=idx[i];if(i<nTrain)state.trainIds.add(id);else state.testIds.add(id)}
  }
  updateAugInfo()
  updateTrainButton()

}
function addSample(){
  const data=to28x28(draw)
  state.samples.push({id:Date.now()+"_"+Math.random(),label:currentLabel(),data})
  renderThumbs();updateCounts()
  if(!state.testLocked){stratifiedSplit();renderThumbs();updateCounts()}
}
function renderThumbs(){
  const maps={"content":"thumb-content","Triste":"thumb-triste","Neutre":"thumb-neutre"}
  for(const lab of labels){const box=document.getElementById(maps[lab]);box.innerHTML=""}
  for(let i=0;i<state.samples.length;i++){
    const s=state.samples[i]
    const c=document.createElement("canvas");c.width=32;c.height=32;c.className="thumb"+(state.testIds.has(i)?" test":"")
    const k=c.getContext("2d");k.fillStyle="#fff";k.fillRect(0,0,32,32)
    const img=document.createElement("canvas");img.width=28;img.height=28
    const ig=img.getContext("2d")
    const im=ig.createImageData(28,28)
    for(let p=0;p<28*28;p++){const v=Math.max(0,Math.min(1,s.data[p]));const x=p*4;const g=255*(1-v);im.data[x]=g;im.data[x+1]=g;im.data[x+2]=g;im.data[x+3]=255}
    ig.putImageData(im,0,0);k.imageSmoothingEnabled=false;k.drawImage(img,2,2,28,28)
    c.addEventListener("click",()=>{if(state.testLocked&&state.testIds.has(i))return;state.samples.splice(i,1);renderThumbs();updateCounts();if(!state.testLocked){stratifiedSplit();renderThumbs();updateCounts()}})
    document.getElementById(maps[s.label]).appendChild(c)
  }
}
function updateCounts(){
  const perClass=labels.map(l=>state.samples.filter(s=>s.label===l).length)
  const trainCounts=labels.map(l=>state.samples.map((s,i)=>[s,i]).filter(([s,i])=>s.label===l&&state.trainIds.has(i)).length)
  const testCounts=labels.map(l=>state.samples.map((s,i)=>[s,i]).filter(([s,i])=>s.label===l&&state.testIds.has(i)).length)
  document.getElementById("classCounts").textContent=labels.map((l,i)=>l+" : "+perClass[i]).join("  ")
  document.getElementById("splitCounts").textContent="Entraînement "+trainCounts.join("/")+"  ·  Test "+testCounts.join("/")
  const sp=document.getElementById("split").value
  document.getElementById("splitLabel").textContent=sp+"/"+(100-sp)
  updateAugInfo()
  updateTrainButton()
}

document.getElementById("add").addEventListener("click",addSample)
document.getElementById("split").addEventListener("input",e=>{
  if(state.testLocked){document.getElementById("lockBadge").textContent="Test verrouillé";document.getElementById("lockBadge").className="badge lock";e.target.value=Math.round(state.splitPct*100);return}
  state.splitPct=parseInt(e.target.value)/100;stratifiedSplit();renderThumbs();updateCounts()
})
function renderLayerControls(){
  const box=document.getElementById('layerControls');box.innerHTML=''
  state.arch.hiddenLayers.forEach((n,idx)=>{
    const row=document.createElement('div');row.className='layer-row'
    const pill=document.createElement('div');pill.className='layer-pill'
    const label=document.createElement('span');label.textContent='Couche '+(idx+1)
    const minus=document.createElement('button');minus.textContent='-'
    const count=document.createElement('span');count.textContent=String(n)
    const plus=document.createElement('button');plus.textContent='+'
    minus.addEventListener('click',()=>{state.arch.hiddenLayers[idx]=Math.max(1,state.arch.hiddenLayers[idx]-1);count.textContent=String(state.arch.hiddenLayers[idx]);renderNNGraph()})
    plus.addEventListener('click',()=>{state.arch.hiddenLayers[idx]=Math.min(12,state.arch.hiddenLayers[idx]+1);count.textContent=String(state.arch.hiddenLayers[idx]);renderNNGraph()})
    pill.appendChild(label);pill.appendChild(minus);pill.appendChild(count);pill.appendChild(plus)
    row.appendChild(pill)
    box.appendChild(row)
  })
}
document.getElementById('addLayer').addEventListener('click',()=>{if(state.arch.hiddenLayers.length<3){state.arch.hiddenLayers.push(8);renderLayerControls();renderNNGraph()}})
document.getElementById('removeLayer').addEventListener('click',()=>{if(state.arch.hiddenLayers.length>0){state.arch.hiddenLayers.pop();renderLayerControls();renderNNGraph()}})
function buildModel(){
  if(state.model){state.model.dispose();state.model=null}
  const m=tf.sequential()
  m.add(tf.layers.conv2d({inputShape:[28,28,1],filters:state.arch.filters,kernelSize:3,activation:'relu',padding:'same'}))
  m.add(tf.layers.maxPooling2d({poolSize:2,strides:2}))
  m.add(tf.layers.flatten())
  state.arch.hiddenLayers.forEach(u=>{m.add(tf.layers.dense({units:u,activation:'relu'}))})
  m.add(tf.layers.dense({units:labels.length,activation:'softmax'}))
  m.compile({optimizer:tf.train.adam(),loss:'categoricalCrossentropy',metrics:['accuracy']})
  state.model=m
  renderFilters();renderNNGraph()
}
function tensorsFrom(ids){
  const xs=new Float32Array(ids.length*28*28)
  const ys=new Float32Array(ids.length*labels.length)
  for(let i=0;i<ids.length;i++){
    const s=state.samples[ids[i]]
    xs.set(s.data,i*28*28)
    const li=labels.indexOf(s.label)
    ys[i*labels.length+li]=1
  }
  const xt=tf.tensor4d(xs,[ids.length,28,28,1])
  const yt=tf.tensor2d(ys,[ids.length,labels.length])
  return[xt,yt]
}
function arrToCanvas28(arr){
  const c=document.createElement('canvas');c.width=28;c.height=28;const g=c.getContext('2d')
  const im=g.createImageData(28,28)
  for(let p=0;p<28*28;p++){const v=Math.max(0,Math.min(1,arr[p]));const val=Math.floor(255*(1-v));const x=p*4;im.data[x]=val;im.data[x+1]=val;im.data[x+2]=val;im.data[x+3]=255}
  g.putImageData(im,0,0);return c
}
function canvasToArr28(c){
  const g=c.getContext('2d');const d=g.getImageData(0,0,28,28).data
  const arr=new Float32Array(28*28)
  for(let i=0,j=0;i<d.length;i+=4,j++){const r=d[i],g2=d[i+1],b=d[i+2];arr[j]=1-((r+g2+b)/3/255)}
  return arr
}
function augmentArr(arr){
  const src=arrToCanvas28(arr);const dst=document.createElement('canvas');dst.width=28;dst.height=28;const g=dst.getContext('2d')
  g.fillStyle='#fff';g.fillRect(0,0,28,28)
  const ang=(Math.random()*30-15)*Math.PI/180
  const dx=Math.floor(Math.random()*5-2)
  const dy=Math.floor(Math.random()*5-2)
  const sc=1+(Math.random()*0.2-0.1)
  g.translate(14+dx,14+dy);g.rotate(ang);g.scale(sc,sc);g.imageSmoothingEnabled=false;g.drawImage(src,-14,-14,28,28)
  return canvasToArr28(dst)
}
function tensorsFromWithAug(ids){
  if(!state.augment){return tensorsFrom(ids)}
  const perClassIdx=labels.map(()=>[])
  for(const i of ids){const li=labels.indexOf(state.samples[i].label);perClassIdx[li].push(i)}
  const allX=[];const allY=[]
  for(let li=0;li<labels.length;li++){
    const baseIdx=perClassIdx[li]
    for(const i of baseIdx){allX.push(state.samples[i].data);allY.push(li)}
    let need=Math.max(0,state.targetPerClass-baseIdx.length)
    while(need>0 && baseIdx.length>0){const pick=baseIdx[Math.floor(Math.random()*baseIdx.length)];allX.push(augmentArr(state.samples[pick].data));allY.push(li);need--}
  }
  const n=allX.length
  const xs=new Float32Array(n*28*28)
  const ys=new Float32Array(n*labels.length)
  for(let i=0;i<n;i++){xs.set(allX[i],i*28*28);ys[i*labels.length+allY[i]]=1}
  const xt=tf.tensor4d(xs,[n,28,28,1])
  const yt=tf.tensor2d(ys,[n,labels.length])
  return [xt,yt]
}
function predictCanvas(canvas){
  if(!state.model)return null
  const arr=to28x28(canvas)
  const xt=tf.tensor4d(arr,[1,28,28,1])
  const y=state.model.predict(xt)
  return y.data().then(v=>{xt.dispose();y.dispose();return Array.from(v)})
}
async function train(){
  if(state.samples.length<6)return
  buildModel()
  if(!state.testLocked){state.testLocked=true;document.getElementById('lockBadge').textContent='Test verrouillé';document.getElementById('lockBadge').className='badge lock'}
  const trainIdx=[...state.trainIds];const testIdx=[...state.testIds]
  if(trainIdx.length===0||testIdx.length===0)return
  const [xtr,ytr]=tensorsFromWithAug(trainIdx);const [xte,yte]=tensorsFrom(testIdx)
  let lastAcc=0
  await state.model.fit(xtr,ytr,{epochs:8,batchSize:32,validationData:[xte,yte],verbose:0,callbacks:{onEpochEnd:(e,logs)=>{lastAcc=logs.acc||logs.accuracy;document.getElementById('trainBadge').textContent='Entraînement : '+((lastAcc||0)*100).toFixed(1)+'%'}}})
  const evalRes=state.model.evaluate(xte,yte);const testAcc=(await evalRes[1].data())[0]
  document.getElementById('testBadge').textContent='Test : '+(testAcc*100).toFixed(1)+'%'
  renderFilters();renderNNGraph()
  xtr.dispose();ytr.dispose();xte.dispose();yte.dispose()
}
function renderFilters(){
  const box=document.getElementById('filters');box.innerHTML=''
  if(!state.model)return
  const w=state.model.getWeights()[0].arraySync()
  const kh=w.length,kw=w[0].length,out=w[0][0][0].length
  for(let f=0;f<out;f++){
    const c=document.createElement('canvas');c.width=32;c.height=32;c.className='filter'
    const g=c.getContext('2d');g.fillStyle='#fff';g.fillRect(0,0,32,32)
    const cell=4
    for(let y=0;y<kh;y++){for(let x=0;x<kw;x++){const v=w[y][x][0][f];const n=Math.max(0,Math.min(1,(v+0.5)));g.fillStyle='rgb('+Math.floor(255*(1-n))+','+Math.floor(255*(1-n))+','+Math.floor(255*(1-n))+')';g.fillRect(x*cell+4,y*cell+4,cell,cell)}}
    box.appendChild(c)
  }
}
function renderNNGraph(){
  const svg=document.getElementById('nnviz');svg.innerHTML=''
  const width=svg.clientWidth||svg.parentElement.clientWidth;const height=svg.clientHeight||240
  svg.setAttribute('viewBox','0 0 '+width+' '+height)
  const nodes=[]
  const inCount=Math.min(state.arch.filters,8)
  for(let i=0;i<inCount;i++){nodes.push({col:0,idx:i})}
  for(let l=0;l<state.arch.hiddenLayers.length;l++){for(let j=0;j<Math.min(state.arch.hiddenLayers[l],10);j++){nodes.push({col:l+1,idx:j})}}
  for(let o=0;o<labels.length;o++){nodes.push({col:state.arch.hiddenLayers.length+1,idx:o,lab:labels[o]})}
  const colsCount=state.arch.hiddenLayers.length+2
function pos(col,idx,count){const x=80+col*((width-160)/(colsCount-1));const y=20+(idx+1)*((height-40)/(count+1));return{x,y}}

  const byCol={}
  for(const n of nodes){byCol[n.col]=byCol[n.col]||[];byCol[n.col].push(n)}
  for(const k in byCol){byCol[k].sort((a,b)=>a.idx-b.idx)}
  const lines=[]
  if(state.model){
    const layers=state.model.layers.filter(l=>l.getClassName()==='Dense')
    const k0=layers[0]?layers[0].getWeights()[0].arraySync():null
    if(k0){
      const block=14*14
      for(let f=0;f<inCount;f++){
        for(let j=0;j<Math.min(state.arch.hiddenLayers[0]||labels.length,10);j++){
          let s=0
          for(let i=0;i<block;i++){s+=Math.abs(k0[f*block+i][j])}
          lines.push({from:{col:0,idx:f},to:{col:1,idx:j},w:s/block,s:1})
        }
      }
    }
    for(let l=1;l<layers.length;l++){
      const k=layers[l].getWeights()[0].arraySync();const rows=Math.min(k.length,10);const colsN=Math.min(k[0].length, l===layers.length-1?labels.length:10)
      let max=1e-6;for(let i=0;i<rows;i++){for(let j=0;j<colsN;j++){max=Math.max(max,Math.abs(k[i][j]))}}
      for(let i=0;i<rows;i++){for(let j=0;j<colsN;j++){const v=k[i][j]/max;lines.push({from:{col:l,idx:i},to:{col:l+1,idx:j},w:Math.abs(v),s:Math.sign(v)})}}
    }
  }
  function drawNode(n){
    const p=pos(n.col,n.idx,byCol[n.col].length)
    const g=document.createElementNS('http://www.w3.org/2000/svg','g')
    const c=document.createElementNS('http://www.w3.org/2000/svg','circle')
    c.setAttribute('cx',p.x);c.setAttribute('cy',p.y);c.setAttribute('r','8');c.setAttribute('fill','#fff');c.setAttribute('stroke','#0b5fff');g.appendChild(c);if(n.lab){const t=document.createElementNS('http://www.w3.org/2000/svg','text');t.setAttribute('x',p.x+12);t.setAttribute('y',p.y+4);t.setAttribute('fill',"#fff");t.setAttribute('font-size','12');t.textContent=n.lab;g.appendChild(t)}
    svg.appendChild(g)
  }
  function drawLink(e){
    const p1=pos(e.from.col,e.from.idx,byCol[e.from.col].length);const p2=pos(e.to.col,e.to.idx,byCol[e.to.col].length)
    const line=document.createElementNS('http://www.w3.org/2000/svg','line');line.setAttribute('x1',p1.x);line.setAttribute('y1',p1.y);line.setAttribute('x2',p2.x);line.setAttribute('y2',p2.y);const col=e.s>=0?'#93c5fd':'#fca5a5';line.setAttribute('stroke',col);line.setAttribute('stroke-width',String(0.5+3*e.w));line.setAttribute('stroke-linecap','round');line.setAttribute('opacity','0.9');svg.appendChild(line)
  }
  for(const arr of Object.values(byCol)){for(const n of arr){drawNode(n)}}
  for(const ln of lines){drawLink(ln)}
}
document.getElementById('addLayer').addEventListener('click',()=>{})
document.getElementById('removeLayer').addEventListener('click',()=>{})
document.getElementById("train").addEventListener("click",train)
document.getElementById("reset").addEventListener("click",()=>{
  state.testLocked=false
  document.getElementById('lockBadge').textContent='Test déverrouillé'
  document.getElementById('lockBadge').className='badge'
  renderFilters()
  renderNNGraph()
  document.getElementById('trainBadge').textContent='Entraînement : –'
  document.getElementById('testBadge').textContent='Test : –'
  updateTrainButton()
})

document.getElementById("predict").addEventListener("click",async()=>{
  const probs=await predictCanvas(testpad);if(!probs)return
  const bars={"content":"bar-content","Triste":"bar-triste","Neutre":"bar-neutre"},pro={"content":"prob-content","Triste":"prob-triste","Neutre":"prob-neutre"}
  for(let i=0;i<labels.length;i++){const name=labels[i];const p=probs[i];document.getElementById(bars[name]).style.width=Math.round(p*100)+"%";document.getElementById(pro[name]).textContent=(p*100).toFixed(1)+"%"}
})
function updateAugInfo(){
  const trainIdx=[...state.trainIds]
  const perClass=labels.map(l=>trainIdx.filter(i=>state.samples[i].label===l).length)
  let eff=0;for(let c of perClass){eff+= state.augment? Math.max(c,state.targetPerClass): c}
  document.getElementById('augInfo').textContent='Entraînement effectif : '+eff
}
renderThumbs();updateCounts();renderLayerControls();renderNNGraph();updateAugInfo();updateTrainButton()

function runTests(){
  console.assert(!document.getElementById('brush'), 'Brush slider should be removed')
  console.assert(!document.getElementById('augToggle'), 'Variations checkbox should be removed')
  console.assert(document.getElementById('augInfo'), 'augInfo element missing')
  try{updateCounts();console.assert(true,'updateCounts runs without throwing')}catch(e){console.error('updateCounts failed',e)}
}
function canTrain(){return state.samples.length>=6 && state.trainIds.size>0 && state.testIds.size>0}
function updateTrainButton(){document.getElementById('train').disabled=!canTrain()}


runTests()
</script>
</body>
</html>
